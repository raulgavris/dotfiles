# tmux kill-window -t number | C-a w for windows view
set-option -g default-shell /bin/zsh

# https://dev.to/iggredible/useful-tmux-configuration-examples-k3g
# https://github.com/rothgar/awesome-tmux
#############################
#         SETTINGS          #
#############################
# remap prefix from 'C-b' to 'C-a'
unbind C-b
set-option -g prefix C-a
bind-key C-a send-prefix

bind r source-file ~/.tmux.conf \; display "Reloaded!"

# Help guide
bind H display-popup -E -w 90% -h 90% "less ~/Projects/dotfiles/tmux/TMUX_GUIDE.md"

set -g mouse on
set -g base-index 1
set -g renumber-windows on
set -g default-terminal "tmux-256color"
set -ga terminal-overrides ",xterm-256color:Tc"

set -g visual-activity on

# Status bar settings
set -g status-interval 5                        # Update every 5 seconds
set -g status-position bottom
set -g status-justify left

# Pane borders - highlight active pane
set -g pane-active-border-style 'fg=colour208,bg=default'
set -g pane-border-style 'fg=colour238,bg=default'

# Auto-rename windows based on current directory
set-option -g automatic-rename on
set-option -g automatic-rename-format '#{b:pane_current_path}'

set-option -g focus-events on
set-option -g history-limit 100000  # Increased for massive logs
set-option -g set-titles on
set-option -sg escape-time 0

setw -g pane-base-index 1
setw -g monitor-activity on

# Copy mode with vi keys
setw -g mode-keys vi
bind-key -T copy-mode-vi 'v' send -X begin-selection
bind-key -T copy-mode-vi 'y' send -X copy-pipe-and-cancel "pbcopy"
bind-key -T copy-mode-vi 'C-v' send -X rectangle-toggle
unbind -T copy-mode-vi MouseDragEnd1Pane  # Don't exit copy mode on mouse release

# Enter copy mode easily
bind [ copy-mode
bind ] paste-buffer

# Pane synchronization (type in all panes at once)
bind S set-window-option synchronize-panes\; display-message "Panes sync: #{?pane_synchronized,ON,OFF}"

bind-key "|" split-window -h -c "#{pane_current_path}"
bind-key "\\" split-window -fh -c "#{pane_current_path}"
bind-key "-" split-window -v -c "#{pane_current_path}"
bind-key "_" split-window -fv -c "#{pane_current_path}"

bind -n C-h select-pane -L
bind -n C-j select-pane -D
bind -n C-k select-pane -U
bind -n C-l select-pane -R

bind -n M-1 select-window -t 1
bind -n M-2 select-window -t 2
bind -n M-3 select-window -t 3
bind -n M-4 select-window -t 4
bind -n M-5 select-window -t 5

bind -r "<" swap-window -d -t -1
bind -r ">" swap-window -d -t +1

bind c new-window -c "#{pane_current_path}"
bind Space last-window
bind-key C-Space switch-client -l

# Session switcher with fzf (replaces default 's')
bind s display-popup -E -w 80% -h 80% "~/.tmux/switchsession.sh"

# Workspace picker (multi-repo)
bind f display-popup -E -w 80% -h 80% "~/.tmux/workspace.sh"

# Quick sessionizer (jump to any project instantly)
bind C-f display-popup -E -w 80% -h 80% "~/.tmux/sessionizer.sh"

# Quick note-taking
bind N display-popup -E -w 80% -h 80% "~/.tmux/notes.sh"

# Kill session via fzf
# Kill session(s) via fzf (multi-select with Tab)
bind K display-popup -E -w 80% -h 80% "~/.tmux/killsession.sh"

# Kill current session (confirm)
bind X confirm-before -p "Kill current session?" kill-session

# Kill all sessions (confirm)
bind Q confirm-before -p "Kill tmux server (all sessions)?" kill-server

# Pane resizing (Ctrl-arrow keys without prefix)
bind -n C-Up resize-pane -U 5
bind -n C-Down resize-pane -D 5
bind -n C-Left resize-pane -L 5
bind -n C-Right resize-pane -R 5

# Quick pane layouts
bind M-1 select-layout even-horizontal
bind M-2 select-layout even-vertical
bind M-3 select-layout main-horizontal
bind M-4 select-layout main-vertical
bind M-5 select-layout tiled

# Show pane numbers longer
set -g display-panes-time 3000

# URL view and open (extract URLs from pane)
bind u run-shell -b "tmux capture-pane -J -p | grep -oE 'https?://[^[:space:]]+' | sort -u | fzf --prompt='Open URL > ' --preview='echo {}' | xargs open"

# Break pane to new window
bind ! break-pane -d

# Join pane from another window
bind @ command-prompt -p "Join pane from window:" "join-pane -h -s %%"

# Clear screen and scrollback history (doesn't use C-l, so no vim conflict)
bind C send-keys -R \; clear-history

# Save pane contents to file (for massive logs)
bind P command-prompt -p 'Save pane to:' 'capture-pane -S -100000 ; save-buffer %1 ; delete-buffer'

# Logging to file (strips colors, auto-opens in Cursor, auto-deletes on stop)
# Start: Creates clean log file and opens it in Cursor
bind-key O pipe-pane -o 'sed -u "s/\x1b\[[0-9;]*m//g" >> ~/logs/tmux-pane-#S-#I-#P.log' \; \
    run-shell 'cursor ~/logs/tmux-pane-#S-#I-#P.log >/dev/null 2>&1 &' \; \
    display-message 'Logging STARTED: ~/logs/tmux-pane-#S-#I-#P.log (opened in Cursor)'
# Stop: Stops logging AND deletes the log file
bind-key o pipe-pane \; run-shell 'rm -f ~/logs/tmux-pane-#S-#I-#P.log' \; display-message 'Logging STOPPED (log deleted)'

# Respawn stuck pane
bind R confirm-before -p "Respawn pane? (kills process)" "respawn-pane -k"

#####################################
#          Plugins Begin            #
#####################################

# git clone https://github.com/tmux-plugins/tpm ~/.tmux/plugins/tpm
set -g @plugin 'tmux-plugins/tpm'

#####################################
#       Plugin Configuration        #
#####################################

# --- Prefix Highlight: Configure BEFORE loading plugin ---
set -g @prefix_highlight_show_copy_mode 'on'
set -g @prefix_highlight_show_sync_mode 'on'
set -g @prefix_highlight_prefix_prompt 'PREFIX'
set -g @prefix_highlight_copy_prompt 'COPY'
set -g @prefix_highlight_sync_prompt 'SYNC'
set -g @prefix_highlight_fg 'colour231'         # white text
set -g @prefix_highlight_bg 'colour04'          # blue background
set -g @prefix_highlight_copy_mode_attr 'fg=colour231,bg=colour05' # magenta for copy mode
set -g @prefix_highlight_sync_mode_attr 'fg=colour231,bg=colour09' # red for sync mode

# --- Theme: onedark (configure BEFORE loading) ---
set -g @onedark_widgets "#{prefix_highlight} | #(~/.tmux/cpu.sh) | #(~/.tmux/memory.sh) | #(~/.tmux/battery.sh) | #(whoami)"
set -g @onedark_time_format "%I:%M %p"
set -g @onedark_date_format "%d-%m-%Y"

# --- Yank: Better clipboard integration ---
set -g @yank_selection 'clipboard'              # Copy to system clipboard
set -g @yank_selection_mouse 'clipboard'        # Mouse selection goes to clipboard
set -g @yank_action 'copy-pipe-no-clear'        # Don't exit copy mode after yank

# --- tmux-fzf: Additional fzf integrations ---
set -g @tmux-fzf-launch-key 'F'                 # prefix + Shift+F for tmux-fzf menu

# https://github.com/tmux-plugins/tmux-resurrect
set -g @plugin 'tmux-plugins/tmux-resurrect'
# https://github.com/tmux-plugins/tmux-continuum
set -g @plugin 'tmux-plugins/tmux-continuum'
# https://github.com/jimeh/tmux-themepack
set -g @plugin 'jimeh/tmux-themepack'
# https://github.com/christoomey/vim-tmux-navigator
set -g @plugin 'christoomey/vim-tmux-navigator'
# https://github.com/tmux-plugins/tmux-yank
set -g @plugin 'tmux-plugins/tmux-yank'
# https://github.com/sainnhe/tmux-fzf
set -g @plugin 'sainnhe/tmux-fzf'
# https://github.com/tmux-plugins/tmux-prefix-highlight
set -g @plugin 'tmux-plugins/tmux-prefix-highlight'
# https://github.com/odedlaz/tmux-onedark-theme
set -g @plugin 'odedlaz/tmux-onedark-theme'

# --- Resurrect: Manual save/restore (prefix + Ctrl-s to save, Ctrl-r to restore) ---
set -g @resurrect-capture-pane-contents 'on'   # Saves what's visible in panes
set -g @resurrect-strategy-vim 'session'        # Restore vim sessions
set -g @resurrect-strategy-nvim 'session'       # Restore nvim sessions

# --- Continuum: Automatic save/restore ---
set -g @continuum-save-interval '5'             # Auto-save every 5 minutes (default: 15)
set -g @continuum-restore 'on'                  # Auto-restore when tmux starts

# Auto-start tmux on Mac boot (commented - uncomment to enable)
set -g @continuum-boot 'on'
set -g @continuum-boot-options 'iterm'

####################################
#          Plugins End             #
####################################


# initialize TMUX plugin manager (keep this line at the very bottom of tmux.conf)
run '~/.tmux/plugins/tpm/tpm'
